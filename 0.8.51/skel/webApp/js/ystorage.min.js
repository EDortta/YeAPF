window.ystorage||Object.defineProperty(window,"ystorage",new function(){var g=[],c={};Object.defineProperty(c,"getItem",{value:function(a){return a?this[a]:null},writable:!1,configurable:!1,enumerable:!1});Object.defineProperty(c,"key",{value:function(a){return g[a]},writable:!1,configurable:!1,enumerable:!1});Object.defineProperty(c,"setItem",{value:function(a,c){a&&(document.cookie=escape(a)+"="+escape(c)+"; expires=Tue, 19 Jan 2038 03:14:07 GMT; path=/")},writable:!1,configurable:!1,enumerable:!1});
Object.defineProperty(c,"length",{get:function(){return g.length},configurable:!1,enumerable:!1});Object.defineProperty(c,"removeItem",{value:function(a){a&&(document.cookie=escape(a)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/")},writable:!1,configurable:!1,enumerable:!1});this.get=function(){var a,d;for(d in c)a=g.indexOf(d),-1===a?c.setItem(d,c[d]):g.splice(a,1),delete c[d];for(;0<g.length;g.splice(0,1))c.removeItem(g[0]);for(var b=0,e=document.cookie.split(/\s*;\s*/);b<e.length;b++)a=e[b].split(/\s*=\s*/),
1<a.length&&(c[d=unescape(a[0])]=unescape(a[1]),g.push(d));return c};this.configurable=!1;this.enumerable=!0});
window.ySingleDb||(console.log("Creating ySingleDb ... "),window.ySingleDb=function(g){var c={_list:null,toBinArray:function(a){for(var c=(a||"").length,b=new Uint8Array(c),e=0;e<c;e++)b[e]=a.charCodeAt(e);return b},toBinString:function(a){a=new Uint8Array(a);for(var c=[],b=0;65535*b<a.length;b++)c.push(String.fromCharCode.apply(null,a.subarray(65535*b,65535*(b+1))));return c.join("")},setItem:function(a,d){a=String(a);d._id=d._id||generateUUID();d._ts_update=(new Date).getTime()/1E3;localStorage.setItem(c._dbTag_+
"_item_"+a,JSON.stringify(d));-1==c._list.indexOf(a)&&(c._list[c._list.length]=a,localStorage.setItem(c._dbTag_+"_list",JSON.stringify(c._list)))},setBinItem:function(a,d){c.setItem(a,c.toBinString(d))},getItem:function(a){a=String(a);a=localStorage.getItem(c._dbTag_+"_item_"+a);return a=JSON.parse(a||"{}")},getBinItem:function(a){return c.toBinArray(c.getItem(a))},getList:function(){return c._list||[]},filter:function(a,d,b){if("function"==typeof a){b=yLexObj(b||!0);b.parse();var e,h=c.getList(),
f,k;for(e=0;e<h.length;e++)f=c.getItem(h[e]),(k=b.solve(f))&&a(f)}"function"==typeof d&&d()},each:function(a,d,b){var e=function(b,a){a=String(a).split(" ");var c=!0,e,h;for(e in a)h=trim(a[e]),c=isNumber(h)&&isNumber(b)?c&&parseFloat(h)===parseFloat(b):c&&0<=(""+b).toUpperCase().indexOf(h.toUpperCase());return c},h,f=c.getList(),k,l;for(h=0;h<f.length;h++)if("function"==typeof a){k=c.getItem(f[h]);l="undefined"==typeof b;if(!l)if("string"==typeof b)l=e(k[c.cfg.keyName],b);else if("object"==typeof b){l=
!0;for(var g in b)b.hasOwnProperty(g)&&(l="undefined"!==typeof k[g]?l&&e(k[g],b[g]):!1)}l&&a(k)}"function"==typeof d&&d()},fillList:function(a,d,b){d=d||"id";b&&c.cleanList();for(b=0;b<a.length;b++)a[b][d]&&c.setItem(a[b][d],a)},removeItem:function(a){if("function"==typeof c.onremove)c.onremove(c.getItem(a));localStorage.removeItem(c._dbTag_+"_item_"+a);a=c._list.indexOf(String(a));-1<a&&(c._list.splice(a,1),localStorage.setItem(c._dbTag_+"_list",JSON.stringify(c._list)))},cleanList:function(){var a=
[],d=0,b;for(b in c._list)a[d++]=c._list[b];for(d=0;d<a.length;d++)c.removeItem(a[d])},init:function(a){c._dbTag_=a;console.log("ystorage: creating "+a);c._list=localStorage.getItem(c._dbTag_+"_list");"string"==typeof c._list&&(c._list=JSON&&JSON.parse(c._list)||[]);c._list=c._list||[];return c}};return c.init(g)},console.log("ystorage ready!"));
window.yServerWatcherObj||(window.yServerWatcherObj=function(g){var c={serverReady:function(a,c){var b=(new Date).getTime();ycomm.crave("sync","ping",null,function(e,h,f){200==e?0<parseInt(f.pong||0)&&(e=(new Date).getTime()-b,console.log("Server ready..."),console.log("Wasted time: {0}ms".format(e)),ycomm.wd_interval=4*e,"function"==typeof a&&a()):"function"==typeof c&&c(e,h)})},init:function(){ycomm.setDataLocation(g);c.serverReady(function(){console.log("Server ready!")});return c}};return c.init()});
window.yInfoObj||(window.yInfoObj=function(g,c,a,d){var b={};b.cfg={db:ySingleDb(c),garbage:ySingleDb(c+"_garbage"),dbName:c,keyName:a,dataModified:0,onrecordcount:null,onprogress:null,oncomplete:null};b.onremove=function(a){a._ts_deletion=(new Date).getTime()/1E3;b.cfg.garbage.setItem(a._id,a);b.cfg.dataModified++};b.isbusy=function(){return b.busy};b.getItem=function(a){return b.cfg.db.getItem(a)};b.setItem=function(a,c){b.cfg.dataModified++;return b.cfg.db.setItem(a,c)};b.removeItem=function(a){return b.cfg.db.removeItem(a)};
b.filter=function(a,c,f){return b.cfg.db.filter(a,c,f)};b.each=function(a,c,f){return b.cfg.db.each(a,c,f)};b.paint=b.each;b.count=function(a){var c=0;b.each(function(){c++},null,a);return c};b.extractData=function(a,c){var f=[];b.each(function(b){f[f.length]=b},function(){a(f)},c)};b.insertData=function(a){for(var c=0;c<a.length;c++)b.setItem(a[c][b.cfg.keyName],a[c])};b.cleanCondition=function(){b.cfg.condition={}};b.setCondition=function(a){if("string"==typeof a){a=a.match(/\S+/g);var c,f="";for(c=
0;c<a.length;c++)isNumber(a[c])||isOperator(a[c])||(a[c]="%("+a[c]+")"),f+=a[c]+" ";b.cfg.condition={_statement_:f}}else b.cfg.condition=a||{}};b._retrieveFromServer=function(){var a={xq_start:b.cfg.xq_start,xq_collectionName:b.cfg.dbName},c=(new Date).getTime();mergeObject(b.cfg.condition,a);ycomm.crave("sync","getDocumentInSequence",a,function(a,e,d){if(0<d.length){b.cfg.interleave.adjustRestTime(c);for(a=0;a<d.length;a++)if(b.setItem(d[a][b.cfg.keyName],d[a]),"function"==typeof b.cfg.onprogress)b.cfg.onprogress(b.cfg.dbName,
d[a],b.cfg.xq_start+a);b.cfg.xq_start+=d.length;setTimeout(b._retrieveFromServer,b.cfg.interleave.restTime)}else{if("function"==typeof b.cfg.oncomplete)b.cfg.oncomplete(b.cfg.dbName);b.busy=!1}})};b.retrieveFromServer=function(a,c,d){if(b.busy)return console.warn("yInfoObj busy"),!1;b.busy=!0;b.cfg.onrecordcount=a||null;b.cfg.oncomplete=c||null;b.cfg.onprogress=d||null;b.server.serverReady(function(){ycomm.crave("sync","getRecordCount",b.cfg.condition,function(a,c,d){d=d||[];d[0]=d[0]||{};if("function"==
typeof b.cfg.onrecordcount)b.cfg.onrecordcount(b.cfg.dbName,parseInt(d[0].CC||0));b.cfg.xq_start=0;b._retrieveFromServer()})},function(b,a){console.log("Erro {0} ao tentar acessar o servidor: {1}".format(b,a.message))});return!0};b.templatedData=function(a){var c;if(b.cfg.dataTemplateEmpty)c=a;else{c={};for(var d in b.cfg.dataTemplate)b.cfg.dataTemplate.hasOwnProperty(d)&&(c[d]=a[d])}return c};b.sendToServer=function(a,c){if(b.busy)return console.warn("yInfoObj busy"),!1;b.busy=!0;b.cfg.onrecordcount=
null;b.cfg.oncomplete=a||null;b.cfg.onprogress=c||null;var d=0;b.server.serverReady(function(){b.each(function(a){var c=b.templatedData(a);a._ts_upload=(new Date(a)).getTime()/1E3;mergeObject(b.cfg.condition,c);ycomm.crave("sync","setDocument",c,function(a,c,e){if(200==a&&"function"==typeof b.cfg.onprogress)b.cfg.onprogress(b.cfg.dbName,e[0],++d)})},function(){if("function"==typeof b.cfg.oncomplete)b.cfg.oncomplete(b.cfg.dbName);b.busy=!1},b.cfg.condition)},function(b,a){console.log("Erro {0} ao tentar acessar o servidor: {1}".format(b,
a.message))});return!0};b.init=function(a){b.cfg.interleave=yRestTimeControl(500);b.cfg.dataTemplateEmpty="undefined"===typeof a?!0:!1;b.cfg.dataTemplate=a||{};b.cfg.db.onremove=b.onremove;b.server=yServerWatcherObj(g);b.cleanCondition();return b};return b.init(d)});
