#!/usr/bin/php
<?php
/*
tools/distributionBuilder/ydocview
YeAPF 0.8.63-120 built on 2019-07-20 14:22 (-3 DST)
Copyright (C) 2004-2019 Esteban Daniel Dortta - dortta@yahoo.com - MIT License
2019-07-20 12:35:24 (-3 DST)
*/

if (!function_exists("objet2array")) {
  function object2array($object) {
    return @json_decode(@json_encode($object), 1);
  }
}

global $outputFiles, $ofNdx, $aSequence, $aMap;
$ofNdx       = -1;
$aSequence   = -1;
$aMap        = array();
$outputFiles = array();

function writeHTMLHeader($margin, $title="", $htmlFilename="") {
  global $outputFiles, $ofNdx;
  if ($htmlFilename=="")
    $htmlFilename=$outputFiles[$ofNdx];

  $auxBase = str_replace("//", "/", dirname($htmlFilename));
  $auxBase = y_solve_parent_reference($auxBase);
  $slashCount = substr_count($auxBase,"/") - 1;
  $base     = str_repeat("../", $slashCount);
  $thisFileName=$title;
  if ($title=="")
    $thisFileName=$htmlFilename;

  $thisFileName=str_replace(".html", "", $thisFileName);
  $thisFileName="<a onclick='goBack()'><i class='fa fa-chevron-left' aria-hidden='true'></i></a>&nbsp;$thisFileName";

  file_put_contents($htmlFilename, "\n<!-- [ $base ] -->\n", FILE_APPEND);

  if (true) {
    $htmlText = "<!DOCTYPE html>
                  <html lang='en'>
                    <head>
                      <meta charset='utf-8' />
                      <meta http-equiv='x-ua-compatible' content='ie=edge' />
                      <meta name='viewport' content='width=device-width, initial-scale=1' />

                      <title>$title</title>

                      <link rel='stylesheet' href='".$base."css/normalize.css' />
                      <link rel='stylesheet' href='".$base."css/milligram.css' />
                      <link rel='stylesheet' href='".$base."css/roboto.css' />
                      <link rel='stylesheet' href='".$base."css/font-awesome.css' />
                      <link rel='icon' href='".$base."images/favicon.png' />
                      <script src='".$base."js/yloader.min.js'></script>
                      <script src='".$base."js/ydocviewer.js'></script>
                    </head>

                    <style>
                      .docEntry {
                        padding-left: 16px;
                      }
                    </style>

                    <script>
                    window.homeHistoryPosition = 0;
                      function goBack() {window.history.go(homeHistoryPosition);}
                    </script>

                    <body><h2>$thisFileName</h2>\n";
  } else {
    $htmlText="<!DOCTYPE html><html lang='en'><body>\n";
  }
  $htmlText .= "\n<!-- ".dirname($htmlFilename)."/$base -->\n";
  file_put_contents($htmlFilename, $htmlText, FILE_APPEND);
  chmod($htmlFilename, 0755);
}

function writeHTMLFooter($margin, $htmlFilename="") {
  global $outputFiles, $ofNdx;
  if ($htmlFilename=="")
    $htmlFilename=$outputFiles[$ofNdx];

  $htmlText = "<hr>\n";
  if ($margin<=1)
    $htmlText.="<small>YeAPF documenter 0.8.63 - Copyright (C) 2004-2019 Esteban Daniel Dortta - dortta@yahoo.com - MIT License</small></body></html>\n";
  file_put_contents($htmlFilename, $htmlText, FILE_APPEND);
  chmod($htmlFilename, 0755);
}

function replace_extension($filename, $new_extension) {
    $info = pathinfo($filename);
    $currentExt = '.'.$info['extension'];
    return $info['dirname'].'/'.$info['filename'] . $new_extension;
}

function processMDFile($sourceFilename) {
  global $baseToExport, $currentSourceFileName, $mdSourceFolder;

  $currentSourceFileName=$sourceFilename;
  $Parsedown = new Parsedown();
  $sourceFileContent = @file_get_contents($currentSourceFileName);
  $currentSourceFileName = y_solve_parent_reference(substr($currentSourceFileName, strlen($baseToExport)));
  $ret = $Parsedown->text($sourceFileContent."\n\n>$currentSourceFileName");

  $pattern = '/<a[^>]+href=([\'"])(?<href>\/[a-z\-\/\.\#\_]*)\1[^>]*>/i';
  $ret = preg_replace_callback($pattern, function ($matches) {
            global $baseToExport, $currentSourceFileName;
            $aux=$matches[0];
            // $c=substr_count($matches[0], "/")-1;
            $c=substr_count($currentSourceFileName, "/")-1;

            $cc=preg_match('/([\'\"])(?<href>\/[a-z\-\/\.\#\_]*)\1[^>]*>/i', $matches[0], $arranjo);
            if ($cc) {
              $quote = $arranjo[1];
              $target = $arranjo[2]; 

              $fileLocation = str_replace('//', '/', $baseToExport.dirname($currentSourceFileName)."/".str_repeat("../", $c).$target);          
              $fileLocation=y_solve_parent_reference($fileLocation);

              $fileResourceLocation = explode("#", $fileLocation);
              $ext = pathinfo($fileResourceLocation[0], PATHINFO_EXTENSION);
              if (mb_strtolower($ext)=="md") {
                DIE("RESOLVER ISTO AQUI:");
                $mdSource=explode(",", $mdSourceFolder);
                $found=false;
                for($c=0; $c<count($mdSource) && !$found; $c++) {
                  $folder=$mdSource[$c];
                  if ($folder!=$baseToExport) {
                    $sourceFilename = str_replace($baseToExport, $folder, $sourceFilename);
                    $found=file_exists($sourceFilename);
                  }
                }

                if (file_exists($fileResourceLocation[0])) {
                  $newFilename = str_replace(".$ext", ".html", $fileResourceLocation[0]);
                  $htmlTextFromMD=processMDFile($fileResourceLocation[0]);

                  $aName=basename($currentSourceFileName);

                  $htmlText = "<div class='container'><div class='row'><div class='column'><div class='docEntry' id='$aName' style='display:block'>$htmlTextFromMD</div></div></div></div>";


                  if (file_exists($newFilename))
                    unlink($newFilename);
                  writeHTMLHeader(0, $target, $newFilename);
                  if (!@file_put_contents($newFilename, $htmlText, FILE_APPEND)) {
                    die("Was not possible to write $newFilename\n");
                  } else {
                    $target=str_replace(".$ext", ".html", $target);
                  }
                } else
                  echo "File not found: $fileResourceLocation[0]\n";
              }


              $url=str_repeat("../", $c).$target;
              $url=str_replace('//', '/', $url);
              $href="<a href=\"$url\">";
            }
            return $href;
        }, $ret);
  return $ret;
}

function writeHTMLInfo($htmlText, $detailName="", $detail=null) {
  global $baseToExport, $mdSourceFolder, $toExport, $outputFiles, $ofNdx, $aMap, $aSequence, $doPartial, 
         $currentSourceFileName;

  $canDo = false;
  if ($toExport) {
    $htmlText = trim($htmlText);
    if ($htmlText > '') {
      $aSequence++;
      $aName          = $detailName; //md5($aSequence);
      $targetFileName = substr($outputFiles[$ofNdx], strlen($baseToExport) + 1);
      if ($detailName > "") {
        $sourceFilename = replace_extension($outputFiles[$ofNdx], ".auxmd");
        $sourceFilename = str_replace(".auxmd", "-$detailName.md", $sourceFilename);
        if (!file_exists($sourceFilename)) {
          $mdSource=explode(",", $mdSourceFolder);
          $found=false;
          for($c=0; $c<count($mdSource) && !$found; $c++) {
            $folder=$mdSource[$c];
            if ($folder!=$baseToExport) {
              $sourceFilename = str_replace($baseToExport, $folder, $sourceFilename);
              $found=file_exists($sourceFilename);
            }
          }
        }
        if (file_exists($sourceFilename)) {
          $documentationText = processMDFile($sourceFilename);
          $canDo=true;
        } else {
          $documentationText="File <b>$sourceFilename</b> not found.";
          $canDo = !$doPartial;
        }
      } else {
        $documentationText="Write your doc here...";
        $canDo=true;
      }
      if ($canDo) {
        /* main index entry */
        if (!isset($aMap[$targetFileName]))
          $aMap[$targetFileName] = array();
        $aMap[$targetFileName][$htmlText] = $targetFileName . "#$aName";

        if (is_array($detail)) {
          if ((isset($detail['code'])) && (!$doPartial)) {
            $codeInfo = ' md5: '.$detail['code']['md5'].' start: '.$detail['code']['start'].' end: '.$detail['code']['end'];
            $documentationText = "\n\n<div><pre>$codeInfo</pre></div>\n\n$documentationText\n\n";
          }
        }
        /* html body */
        $htmlText = "<div class='container'><div class='row'><div class='column'><a name='$aName'></a><h3><a href='#$aName' class='expand-document' data-id='$aName'><i class='fa fa-caret-right expander-$aName'></i>&nbsp;&nbsp;$htmlText</a></h3></div></div><div class='row'><div class='column'><div class='docEntry' id='$aName' style='display: none'>$documentationText</div></div></div></div>";
        file_put_contents($outputFiles[$ofNdx], $htmlText, FILE_APPEND);
        chmod($outputFiles[$ofNdx], 0755);
      }
    }
  }
  return $canDo;
}

function showXdbInfo($margin, $xml, $type = 'file') {
  global $baseToExport, $toExport, $outputFiles, $ofNdx, $toDestroy;

  $toDebug = true;

  $oldOfNdx = $ofNdx;

  $textReturn = "";
  if (isset($xml)) {
    $xml       = object2array($xml);
    $marginStr = str_repeat(" ", $margin * 2);
    foreach ($xml as $info => $detail) {
      if ($type == 'file') {
        if (isset($detail['folder'])) {
          $textReturn .= urldecode($marginStr . "$info at " . $detail['folder'] . "\n");
          if ($toExport) {
            $auxOutFolder = urldecode("$baseToExport/" . $detail['folder']);
            if (!file_exists($auxOutFolder))
              mkdir($auxOutFolder, 0755, true);
            $ofNdx++;
            $outputFiles[$ofNdx] = "$auxOutFolder/$info.html";
            if ($toExport) {
              if (file_exists($outputFiles[$ofNdx])) {
                if ($toDestroy) {
                  if (!unlink($outputFiles[$ofNdx]))
                    die("'" . $outputFiles[$ofNdx] . "' cannot be deleted");
                } else
                  die("'" . $outputFiles[$ofNdx] . "' already exists. Use '-d' to destroy\n");
              }
            }
          }
        }
      } else if ($type == 'func') {
        if (!is_numeric($info)) {
          if (isset($detail['name']))
            $detailName = $detail['name'];
          else
            $detailName = "";
          $funcDeclaration = urldecode($marginStr . "function " . $detailName . " (");
          $pCount          = 0;
          if (isset($detail['parameters'])) {
            foreach ($detail['parameters'] as $paramName => $dummy) {
              if ($pCount++ > 0)
                $funcDeclaration .= ", ";
              $funcDeclaration .= $paramName;
            }
          }
          $funcDeclaration .= ")\n";
          if (writeHTMLInfo($funcDeclaration, $detailName, $detail)) {
            if ($detailName>"") {
              $textReturn .= $funcDeclaration;            
            }
          }

        }
      } else if ($type == 'class') {
        if (!is_numeric($info)) {
          $textReturn .= urldecode($marginStr . "class $info\n");
          writeHTMLInfo("class $info");
        }
      } else if ($type == 'inner') {
        $textReturn .= "*";
      }
      if ($type == 'file') {
        writeHTMLHeader($margin, $outputFiles[$ofNdx]);
      }
      $insideInfo = viewInside($margin, $detail);
      if ($type == 'file') {
        writeHTMLFooter($margin);
      }
      $textReturn .= $insideInfo;
    }
  }
  $ofNdx = $oldOfNdx;
  return $textReturn;
}

function viewInside($margin, $detail) {

  $textReturn = "";
  $marginStr  = str_repeat(" ", $margin * 2);

  if (isset($detail['inner'])) {
    $textReturn .= viewInside($margin + 1, $detail['inner']);
  }
  if (isset($detail['classes'])) {
    $textReturn .= showXdbInfo($margin + 1, $detail['classes'], 'class');
  }
  if (isset($detail['functions'])) {
    $textReturn .= showXdbInfo($margin + 1, $detail['functions'], 'func');
  }

  return $textReturn;
}

$mydir      = dirname($_SERVER['SCRIPT_FILENAME']);
$cmRequired = false;
if (file_exists("$mydir/yclilib.php"))
  $cmLocation = "$mydir/yclilib.php";
else
  $cmLocation = "$mydir/../yclilib.php";

(@include_once "$cmLocation") or die("yclilib.php not found\n");

$parseDownLibPresent=false;
if (file_exists("$mydir/lib/Parsedown.php")) {
  (@include_once "$mydir/lib/Parsedown.php") or die("$mydir/lib/Parsedown.php not found\n");
  $parseDownLibPresent=true;
}
else
  echo "Parsedown library ($mydir/lib/Parsedown.php) not found.\nYou cannot do partial documentation\n";

$cwd            = getcwd();
$args           = new ArgumentsProcessor(false);
$myself         = basename($argv[0]);
$filename       = $args->getSrc(0);
$baseToExport   = $args->getSrc(1);
$mdSourceFolder = $args->argValue('mdsource;s', $baseToExport);
$toHelp         = $args->argValue('help;h', __FALSE__) == __TRUE__;
$toDestroy      = $args->argValue('destroy;d', __FALSE__) == __TRUE__;
$doQuiet        = $args->argValue('quiet;q', __FALSE__) == __TRUE__;
$doPartial      = ($args->argValue('partial;p', __FALSE__) == __TRUE__) && ($parseDownLibPresent);
$toExport       = trim($baseToExport) > '';


echo "YeAPF 0.8.63 $myself\nCopyright (C) 2004-2019 Esteban Daniel Dortta - dortta@yahoo.com - MIT License\n";
if (($toHelp) || (trim($filename) == '')) {
  echo "usage:\n";
  echo "\t$myself <filename> [output-folder] [--destroy] [--partial] [--quiet]\n";
  echo "\t\tfilename\tis a .xdb created by ydocbuilder\n";
  echo "\t\toutput-folder\tis used to write html files\n";
  echo "\t\t--quiet   \t(-q) shows minimal information\n";
  echo "\t\t--destroy \t(-d) clean the output-folder (delete all html files in folder)\n";
  echo "\t\t--partial \t(-p) write information only for those items that have a .md correspondent file\n";
  echo "\t\t--mdsource\t(-s) indicate where .md files are located. By default are at 'output-folder'. use ',' to split folders\n";
  echo "\nIn orther to create your .md files, you can use a tool like https://stackedit.io/app#\n";
  echo "\nIn such case, you need to create each file with .md extension\n";
  echo "\nFor example: lib/grant_rights.js will become lib/grant_rights.js.md\n";
  echo "\nNOTE: .md files are not deleted with -d parameter\n";
  exit(0);
}

_LOAD_YEAPF_();




// ydocviewer.min.js
$ydocviewer_min_js=base64_decode("dmFyIHlEb2NWaWV3ZXJPYmo9ZnVuY3Rpb24oKXsidXNlIHN0cmljdCI7dmFyIHQ9e2V4cGFuZERvY3VtZW50OmZ1bmN0aW9uKHQpe3ZhciBlPXkkKCIuZG9jRW50cnkiKSxuPSExO2lmKGUpe2UuZm9yRWFjaChmdW5jdGlvbih0KXt0LnN0eWxlLmRpc3BsYXk9Im5vbmUifSk7dmFyIG89eSQodCk7aWYobnVsbD09byYmMT09ZS5sZW5ndGgmJihvPWVbMF0pLG8pe28uc3R5bGUuZGlzcGxheT0iIjt2YXIgYT15JCgiLmV4cGFuZGVyLSIrdCk7YSYmKChhPWFbMF0pLmFkZENsYXNzKCJmYS1yb3RhdGUtOTAiKSx3aW5kb3cuaG9tZUhpc3RvcnlQb3NpdGlvbi0tLG49ITApfX1yZXR1cm4gbn19LGU9ZnVuY3Rpb24oZSl7aWYoZSYmZS50YXJnZXQpe3kkKCIuZXhwYW5kLWRvY3VtZW50IikuZm9yRWFjaChmdW5jdGlvbih0KXt0LmRlbGV0ZUNsYXNzKCJmYS1yb3RhdGUtOTAiKX0pO3ZhciBuPWUudGFyZ2V0LmNsb3Nlc3QoIkEiKS5nZXRBdHRyaWJ1dGUoImRhdGEtaWQiKTt0LmV4cGFuZERvY3VtZW50KG4pfX07cmV0dXJuIGZ1bmN0aW9uKCl7YWRkRXZlbnQoImV4cGFuZC1kb2N1bWVudCIsImNsaWNrIixlKTt2YXIgbixvPWRvY3VtZW50LmxvY2F0aW9uLmhyZWYuc3BsaXQoIiMiKTsoby5sZW5ndGg9Mik/dC5leHBhbmREb2N1bWVudChvWzFdKXx8KHdpbmRvdy5ob21lSGlzdG9yeVBvc2l0aW9uPS0xKToxPT0obj15JCgiLmV4cGFuZC1kb2N1bWVudCIpKS5sZW5ndGgmJnQuZXhwYW5kRG9jdW1lbnQoblswXS5nZXRBdHRyaWJ1dGUoImRhdGEtaWQiKSl9KCl9O2FkZE9uTG9hZE1hbmFnZXIoZnVuY3Rpb24oKXt3aW5kb3cueURvY1ZpZXdlcj15RG9jVmlld2VyT2JqKCl9KTs=");

if (file_exists($filename)) {
  $xml = simplexml_load_file($filename);
  if ($toExport) {
    if (is_dir($baseToExport)) {
      if (file_exists("$baseToExport/$filename.html")) {
        if ($toDestroy) {
          if (!unlink("$baseToExport/$filename.html"))
            die("\nimpossible to delete '$baseToExport/$filename.html'\n");
        } else
          die("\n'$baseToExport/$filename.html' already exists. You can use '-d' parameter to destroy it\n");
      }
    } else if (!mkdir($baseToExport))
      die("\nimpossible to create '$baseToExport'\n");
  }

  $xdbInfo = showXdbInfo(0, $xml);
  if (!$doQuiet)
    echo $xdbInfo;
  $docMap = "<!DOCTYPE html>
              <html lang='en'>
                <head>
                  <meta charset='utf-8' />
                  <meta http-equiv='x-ua-compatible' content='ie=edge' />
                  <meta name='viewport' content='width=device-width, initial-scale=1' />

                  <title>" . basename($filename) . "</title>

                  <link rel='stylesheet' href='css/normalize.css' />
                  <link rel='stylesheet' href='css/milligram.css' />
                  <link rel='stylesheet' href='css/roboto.css' />
                  <link rel='stylesheet' href='css/font-awesome.css' />
                  <link rel='icon' href='images/favicon.png' />
                  <script src='js/yloader.min.js'></script>
                  <script src='js/ydocviewer.js'></script>
                </head>

                <style>
                  .docEntry {
                    padding-left: 16px;
                  }
                </style>

                <body><div class='container'><div class='row'><div class='column'><h1>YeAPF Documenter</h1><h3>YeAPF 0.8.63</h3><strong>Copyright (C) 2004-2019 Esteban Daniel Dortta - dortta@yahoo.com - MIT License</strong></div></div>";

  ksort($aMap);

  foreach ($aMap as $fileName => $elements) {
    $fileName = str_replace(".html", "", $fileName);
    $docMap .= "\n\n<div class='row'><div class='column'><h2>$fileName</h2></div></div>\n";
    $docMap .= "<div class='row'><div class='column'><ul>";
    foreach ($elements as $elemName => $aHref)
      $docMap .= "\t<li><a href='$aHref'>$elemName</a></li>\n";
    $docMap .= "</ul>\n</div><!--column-->\n</div><!--row-->\n";
  }
  $docMap .= "</div><!--container-->\n</body>\n</html>\n";
  file_put_contents("$baseToExport/" . basename($filename) . ".html", $docMap);

  if (!file_exists("$baseToExport/js/ydocviewer.min.js")) {
    if (!is_dir("$baseToExport/js")) {
      if (@mkdir("$baseToExport/js")) {
        if (false===@file_put_contents("$baseToExport/js/ydocviewer.min.js", $ydocviewer_min_js))
          echo "Was not possible to create '$baseToExport/js/ydocviewer.min.js'\n";
          exit(20);
      } else {
        echo "$baseToExport/js cannot be created\n";
        exit(20);
      }
    }
  }

} else
  die("\nfile '$filename' not found\n");
?>
