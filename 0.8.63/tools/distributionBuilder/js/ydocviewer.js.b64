/*
%FILE_NAME%
%YEAPF_VERSION_LABEL%
%COPYRIGHT_NOTE%
%LAST_FILE_MODIFICATION%
*/

var yDocViewerObj = function () {
  'use strict';
  var that = {};

  that.expandDocumentById = function (id) {
    var docEntryList = y$('.docEntry');
    var ret = false;
    if (docEntryList) {
      docEntryList.forEach(function (e) { e.style.display = 'none'; });
      var docEntry = y$(id) || docEntryList[0];
      id = docEntry.id;
      if (docEntry) {
        docEntry.style.display = '';
        var i = y$('.expander-' + id);
        if (i) {
          i = i[0];
          i.addClass('fa-rotate-90');
          window.homeHistoryPosition--;
          ret = true;
        }
      }
    }
    return ret;
  };

  var expandDocument = function (e) {
    if ((e) && (e.target)) {
      var expandDoumentList = y$('.expand-document');
      expandDoumentList.forEach(function (e) { e.deleteClass('fa-rotate-90'); });
      var a = e.target.closest('A');
      var id = a.getAttribute('data-id');
      that.expandDocumentById(id);
    }
  };

  var init = function () {
    addEvent('expand-document', 'click', expandDocument);
    var href = document.location.href.split("#") || [];

    if (2 == href.length) {
      if (!that.expandDocumentById(href[1])) {
        window.homeHistoryPosition = -1;
      }
    } else {
      var expandDoumentList = y$('.expand-document');
      if (expandDoumentList.length == 1) {
        that.expandDocumentById(expandDoumentList[0].getAttribute('data-id'));
        ret = true;
      }
    }
  };

  return init();
};

addOnLoadManager(function () { window.yDocViewer = yDocViewerObj() });