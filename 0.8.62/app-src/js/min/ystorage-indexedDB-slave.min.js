"undefined"==typeof yloader&&"undefined"!=typeof importScripts&&importScripts("yloader.js");
var yIndexedDBSlaveObj=function(){var a={},B="function"==typeof openDatabase,C=yloader.webKitVersion.split(".")[0],m=!B&&537<=C;m&&(indexedDB="undefined"!=typeof indexedDB?indexedDB:"undefined"!=typeof mozIndexedDB?mozIndexedDB:"undefined"!=typeof webkitIndexedDB?webkitIndexedDB:"undefined"!=typeof msIndexedDB?msIndexedDB:{},IDBTransaction="undefined"!=typeof IDBTransaction?IDBTransaction:"undefined"!=typeof webkitIDBTransaction?webkitIDBTransaction:"undefined"!=typeof msIDBTransaction?msIDBTransaction:
{READ_WRITE:"readwrite"},IDBKeyRange="undefined"!=typeof IDBKeyRange?IDBKeyRange:"undefined"!=typeof webkitIDBKeyRange?webkitIDBKeyRange:"undefined"!=typeof msIDBKeyRange?msIDBKeyRange:{});var l;a.context={status:"undefined"!==typeof indexedDB.open?0:-1};a.sendInformation=function(b,a){var c={cmd:(b||"").trim(),information:a};yloader.isWorker?self.postMessage(c):"undefined"!==typeof parent?parent.postMessage(c,"*"):window.postMessage(c,"*")};a._indicateStatusChanges=function(){a.sendInformation("initialization",
{status:a.status})};a._log=function(b){a.sendInformation("log",{message:b})};a._db_success=function(){a.status=2};a._db_failure=function(){a.status=-2};a._genericCallBack=function(b){setTimeout(function(){a.sendInformation("callback",{cbr:JSON.stringify(b)})},25)};a._getObjectDescriptorByTableName=function(b){for(var g={},c=0;c<a.context.objectStoreDescription.length;c++)a.context.objectStoreDescription[c].name==b&&(g=a.context.objectStoreDescription[c]);return g};var A=function(b,a,c){b=b.keyPath;
if("undefined"!=typeof c)if("string"==typeof b)a[b]=c;else if(isArray(b)){isArray(c)||(0<=c.indexOf(";")?c=c.split(";"):0<=c.indexOf(",")?c=c.split(","):0<=c.indexOf(".")&&(c=c.split(".")));for(var d=0;d<c.length;d++)a[b[d]]=c[d]}return[a,c]},x=function(b,a,c,d,e){e=e||[];d=d||"or";c=A(b,{},c);dataRecord=c[0];c=c[1];a=a.split(",");b="";isArray(c)||(c=[c]);for(var h=0;h<a.length;h++)0>=e.indexOf(a[h])&&(""<b&&(b+=" {0} ".format(d)),b+=a[h]+"="+"'{0}'".format(c[h]||""));return b},v=function(b,a,c){var d=
b.keyPath;b=A(b,a,c);a=b[0];c=b[1];if("string"==typeof d)a._id="undefined"==typeof a[d]?newIdentifier():a[d];else{var e="";d.forEach(function(b){""<e&&(e+=".");e+="undefined"==typeof a[b]?newIdentifier():a[b]});a._id=md5(e)}if("undefined"==typeof a._ts||0>=a._ts)a._ts=str2int((new Date).getTime()/1E3);return a._id};a.count=function(b,g){var c=a._genericCallBack,d=a._getObjectDescriptorByTableName(b),e={dbTag:a.context.dbTag,name:d.name,tableName:b,action:"count",callbackId:g,data:null,result:void 0};
m?(d=l.transaction([b],"readwrite").objectStore(b).count(),d.onsuccess=function(a){e.return=a.target.result;c(e)},d.onerror=function(a){e.return=!1;c(e)}):l.transaction(function(a){var d="select count(*) as cc from {0}".format(b);a.executeSql(d,[],function(a,b){e.return=b.rows.item(0).cc;c(e)},function(a,b){e.return=-1;e.errorMessage=b.message;c(e)})})};a.setItem=function(b,g,c,d){var e=a._genericCallBack,h=a._getObjectDescriptorByTableName(b);d=d||{};v(h,d,c);var f={dbTag:a.context.dbTag,name:h.name,
_id:d._id,tableName:b,action:"setItem",keyValue:c,callbackId:g,data:null,result:void 0},n=function(a,b){f.return=!1;f.errorMessage=b.message;e(f)};m?(g=l.transaction([b],"readwrite").objectStore(b),g.put(d),g.onsuccess=function(a){f.return=!0;e(f)},g.onerror=function(a){f.return=!1;e(f)}):l.transaction(function(c){s(b,function(b,g){for(var k=g.split(","),h="",r="",p="",q=[],z=0;z<k.length;z++){var l=k[z].trim();""<h&&(h+=", ",r+=", ");h+=l;r+="?";"data"==l?q[q.length]=JSON.stringify(d):(""<p&&(p+=
" AND "),p+="{0}='{1}'".format(l,d[l]),q[q.length]=d[l])}var k="DELETE FROM {0} where {1}".format(b,p),m="INSERT INTO {0} ({1}) values({2})".format(b,h,r);a._log(k);c.executeSql(k,[],function(b,d){a._log(m);c.executeSql(m,q,function(a,b){f.return=!0;e(f)},n)},n)})})};a.getItem=function(b,g,c){var d=a._genericCallBack,e=a._getObjectDescriptorByTableName(b),h={dbTag:a.context.dbTag,name:e.name,tableName:b,action:"getItem",keyValue:c,callbackId:g,data:null,result:void 0};m?(g=l.transaction([b],"readonly").objectStore(b).get(c),
g.onsuccess=function(a){h.return=!0;h.data=a.target.result;d(h)},g.onerror=function(a){h.return=!1;d(h)}):l.transaction(function(a){s(b,function(b,g){var t=x(e,g,c,"or"),t="select * from {0} where {1}".format(b,t);a.executeSql(t,[],function(a,b){for(var c=0;c<b.rows.length;c++){h.data={};var e=b.rows.item(c).data||"",e=JSON.parse(e);mergeObject(e,h.data);h.return=!0;d(h)}},function(a,b){h.errorMessage=b.message;h.return=null;d(h)})})})};a.insertData=function(b,g,c,d){var e=a._genericCallBack,h=a._getObjectDescriptorByTableName(b),
f={dbTag:a.context.dbTag,name:h.name,tableName:b,action:"getItem",callbackId:c,data:null,result:void 0},n=0,u=[],t=function(a,c){n--;_dumpy(128,2,b+" OK - dataToInsert "+n);0>=n&&(f.return=!0,e(f))},y=function(a,c){_dumpy(128,2,b+" ERR- dataToInsert "+n);_dumpy(128,2,JSON.stringify(c));n--;0>=n&&(f.return=!1,f._removeThis=!0,e(f))},k=0,w=g.length;if(m){var r=l.transaction([b],"readwrite"),p=r.objectStore(b),q=function(){if(k<w){n--;v(h,g[k]);var a=p.put(g[k]);a.onsuccess=q;a.onerror=y;k++}else t(r,
[])};q()}else s(b,function(b,c){l.transaction(function(d){var e=c.split(","),f=[],p="",l="",q="",r=[],m;n=w;if(k>=w)t(d,[]);else for(k=0;k<w;k++){v(h,g[k]);f=g[k];r=[];f._id=f._id||newIdentifier();f._ts=f._ts||str2int((new Date).getTime()/1E3);for(var p=q=l="",s=0;s<e.length;s++)m=e[s].trim(),""<l&&(l+=", ",q+=", "),l+=m,q="data"==m?q+"'{0}'".format(JSON.stringify(f)):q+"'{0}'".format(f[m]),"data"!==m&&(""<p&&(p+=" AND "),p+="{0}='{1}'".format(m,f[m])),r[r.length]="data"==m?JSON.stringify(f):f[m];
f="DELETE FROM {0} where {1};".format(b,p);l="INSERT INTO {0} ({1}) values({2});".format(b,l,q);u[u.length]=l;a._log(b+" "+k+" "+f);a._log(p.toString());d.executeSql(f,[],function(a,b){var c=u.shift();d.executeSql(c,[],t,y)},y)}})})};a.filter=function(b,g,c,d,e){var h=a._genericCallBack,f;e=a._getObjectDescriptorByTableName(b);d=d||!0;var n={dbTag:a.context.dbTag,name:e.name,tableName:b,action:"getItem",condition:d,data:null,result:void 0},u=!1;if(!0===d)u=!0;else{var t=yLexObj(d);t.parse()}m?l.transaction([b],
"readonly").objectStore(b).openCursor().onsuccess=function(a){a=a.target.result;var b={};if(a){if(f=u||t.solve(a.value))mergeObject(n,b),b.data=a.value,b.return=!0,b.callbackOnItem=g,h(b);a.continue()}else mergeObject(n,b),b.data=null,b.return=!0,b._removeThis=!0,b.callbackOnComplete=c,h(b)}:l.transaction(function(a){var d="select * from {0}".format(b);_dumpy(128,2,d);a.executeSql(d,[],function(a,b){for(var d,e=0;e<b.rows.length;e++){var k=b.rows.item(e).data;"undefined"==k&&(k=void 0);"null"==k&&
(k=null);k=k||"{}";_dumpy(128,2,k);k=JSON.parse(k);_dumpy(128,2,k);f=u||t.solve(k);d={};f&&(mergeObject(n,d),d.data={},mergeObject(k,d.data),d.callbackOnItem=g,d.return=!0,h(d))}d={};mergeObject(n,d);d.data=null;d.return=!0;d._removeThis=!0;d.callbackOnComplete=c;h(d)})})};a.slice=function(a,g,c,d,e,h){};a.removeItem=function(b,g,c){var d=a._genericCallBack,e=a._getObjectDescriptorByTableName(b),h={};v(e,h,c);var f={dbTag:a.context.dbTag,name:e.name,_id:h._id,tableName:b,action:"removeItem",keyValue:c,
callbackId:g,data:null,result:void 0};m?(g=l.transaction([b],"readwrite").objectStore(b),g.onsuccess=function(a){f.return=!0;d(f)},g.onerror=function(a){f.return=!1;d(f)},g.delete(c)):l.transaction(function(a){s(b,function(b,h){var g=x(e,h,c,"and",["_id","data"]),g="delete from {0} where {1}".format(b,g);a.executeSql(g,[],function(a,b){f.return=!0;f.rowsAffected=b.rowsAffected;d(f)},function(a,b){f.errorMessage=b.message;f.return=null;d(f)})})})};a.removeData=function(b,g,c){var d=a._genericCallBack,
e=a._getObjectDescriptorByTableName(b),h={dbTag:a.context.dbTag,name:e.name,_id:null,tableName:b,action:"removeData",keyValue:null,callbackId:g,data:null,result:void 0};m||l.transaction(function(a){s(b,function(b,g){if(isArray(c)){var l="",m=0,k=!1,s=function(){if(!k){k=!0;var a={};mergeObject(h,a);a.return=!0;a.rowsAffected=0;a._removeThis=!0;d(a)}},r=function(a){var f={};mergeObject(h,f);for(var k,v=!0;v;)if(0<c.length){k=c.pop();k=x(e,g,k,"and",["_id","data"]);l="delete from {0} where {1};".format(b,
k);m++;if(0==m%30||0==c.length)v=!1;a.executeSql(l,[],function(b,e){f.return=!0;f.rowsAffected=e.rowsAffected;d(f);0<c.length?r(a):s()},function(a,b){f.errorMessage=b.message;f.return=null;d(f)})}else v=!1,s()};r(a)}})})};a.cleanList=function(a,g,c){};a.blankList=function(a,g){};Object.defineProperty(a,"status",{get:function(){return a.context.status||0},set:function(b){b!=a.status&&(a.context.status=b,a._indicateStatusChanges())},enumerable:!0});Object.defineProperty(a,"dbTag",{get:function(){return a.context.dbTag||
""},enumerable:!0});Object.defineProperty(a,"dbVersion",{get:function(){return a.context.dbVersion||"1"},enumerable:!0});a.receiveMessage=function(b){b=b.data;if(2>a.status)"init"==b.cmd&&D(b.dbTag,b.objectStoreDescription,b.dbVersion);else switch(b.cmd){case "stop":a.status=-1;a.close();break;case "count":a.count(b.tableName,b.callbackId,b.keyValue,b.data);break;case "setItem":a.setItem(b.tableName,b.callbackId,b.keyValue,b.data);break;case "getItem":a.getItem(b.tableName,b.callbackId,b.keyValue);
break;case "insertData":a.insertData(b.tableName,b.dataArray,b.callbackId,b.fieldsToPreserve);break;case "filter":a.filter(b.tableName,b.callbackOnItem,b.callbackOnComplete,b.condition,b.haltOnFirst);break;case "removeItem":a.removeItem(b.tableName,b.callbackId,b.keyValue);break;case "removeData":a.removeData(b.tableName,b.callbackId,b.arrayOfKeys)}};var s=function(b,g){for(var c in a.context.objectStoreDescription)if(a.context.objectStoreDescription.hasOwnProperty(c)){var d="",e=a.context.objectStoreDescription[c];
""<e.keyPath&&(0<=e.keyPath.indexOf(";")?e.keyPath=e.keyPath.split(";"):0<=e.keyPath.indexOf(",")&&(e.keyPath=e.keyPath.split(",")),""<d&&(d+=", "),d+=e.keyPath);""==d&&(d="_id");d+=", data";d=d.replace(/\ /g,"",!0);"*"!=b&&e.name!=b||g(e.name,d)}},D=function(b,g,c){if(""<(b||"")&&0==a.status)if(a.context.dbTag=b,a.context.dbVersion=str2int(c||1),a.context.objectStoreDescription=(g||[]).slice(),a.status=1,m)a._log("Using IndexedDB"),b=indexedDB.open(a.dbTag,a.dbVersion),b.onupgradeneeded=function(b){b=
b.target.result;_dumpy(128,2,"upgraded needed");try{for(var d=0;d<a.context.objectStoreDescription.length;d++){var c=a.context.objectStoreDescription[d];"string"==typeof c.keyPath&&(0<=c.keyPath.indexOf(";")?c.keyPath=c.keyPath.split(";"):0<=c.keyPath.indexOf(",")&&(c.keyPath=c.keyPath.split(",")));"undefined"==typeof c.keyPath&&(c.keyPath="_id");var e={keyPath:c.keyPath};_dumpy(128,2,"CREATING "+c.name);_dumpy(128,2,"  +--\x3e "+JSON.stringify(e));b.createObjectStore(c.name,e)}a._log("Object Store created");
a._db_success()}catch(f){a._log("Error occurred: {0}".format(f.message)),a._db_failure()}},b.onversionchange=function(a){_dumpy(128,2,"********************************");_dumpy(128,2,"** ON VERSION CHANGE ");_dumpy(128,2,"********************************")},b.onsuccess=function(b){l=b.target.result;a._db_success()},b.onerror=a._db_failure;else try{if(a._log("Using WEBSql"),l=openDatabase(a.dbTag+"."+a.dbVersion,a.dbVersion,a.dbTag,41943040),_dumpy(128,2,"DB "+typeof l),l)if(0==(a.context.objectStoreDescription||
[]).length)a._db_success();else{var d=0,e=a.context.objectStoreDescription.length,h=[];b=function(a,b){h[h.length]="CREATE TABLE IF NOT EXISTS {0} ({1})".format(a,b.replace("_id","_id unique"))};for(g=e-1;0<=g;g--)s(a.context.objectStoreDescription[g].name,b);var f=function(b,c){e--;0>=e&&a._db_success()},n=function(b,c){d++;0>=e&&a._db_failure()};l.transaction(function(a){for(var b=0;b<h.length;b++)a.executeSql(h[b],[],f,n)})}else _dumpy(128,2,"Error creating WEBSql database!"),a._db_failure()}catch(u){a._log("Error occurred: {0}".format(u.message)),
a._db_failure()}};return a};function startup(){var a=yIndexedDBSlaveObj();yloader.isWorker?self.addEventListener("message",a.receiveMessage,!1):window.addEventListener("message",a.receiveMessage,!1)}startup();
