(function(){window.ystorage||(window.ystorage=function(){var g=[],h={oStorage:{},getItem:function(a,b){var d=b=b||null;a&&(d=h.oStorage[a]||b);return d},setItem:function(a,b){a&&(h.oStorage[a]=b,document.cookie=escape(a)+"="+escape(b)+"; expires=Tue, 19 Jan 2038 03:14:07 GMT; path=/")},unsetItem:function(a){"undefined"!==typeof h.oStorage[a]&&delete h.oStorage[a]}};Object.defineProperty(h,"item",{get:h.getItem,set:h.setItem,writable:!0,enumerable:!0});Object.defineProperty(h,"key",{value:function(a){return g[a]},
writable:!1,configurable:!1,enumerable:!1});Object.defineProperty(h,"length",{get:function(){return g.length},configurable:!1,enumerable:!1});Object.defineProperty(h,"removeItem",{value:function(a){a&&(document.cookie=escape(a)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/")},writable:!1,configurable:!1,enumerable:!1});h.get=function(){var a,b;for(b in oStorage)a=g.indexOf(b),-1===a?oStorage.setItem(b,oStorage[b]):g.splice(a,1),delete oStorage[b];for(;0<g.length;g.splice(0,1))oStorage.removeItem(g[0]);
for(var d=0,c=document.cookie.split(/\s*;\s*/);d<c.length;d++)a=c[d].split(/\s*=\s*/),1<a.length&&(oStorage[b=unescape(a[0])]=unescape(a[1]),g.push(b));return oStorage};h.configurable=!1;h.enumerable=!0;return h}());window.ySingleDb||(console.log("Creating ySingleDb ... "),window.ySingleDb=function(g,h){var a={_list:null,toBinArray:function(b){for(var a=(b||"").length,c=new Uint8Array(a),e=0;e<a;e++)c[e]=b.charCodeAt(e);return c},toBinString:function(a){a=new Uint8Array(a);for(var d=[],c=0;65535*
c<a.length;c++)d.push(String.fromCharCode.apply(null,a.subarray(65535*c,65535*(c+1))));return d.join("")},setItem:function(b,d,c){var e,f,k;b=String(b);d._id=d._id||generateUUID();d._ts_update=(new Date).getTime()/1E3;if(isArray(c)&&(k=a.getItem(b),!isEmpty(k)))for(e=0;e<c.length;e++)"undefined"!==typeof k[c[e]]&&(d[c[e]]=k[c[e]]);if(d._linked){for(e=0;e<d._linked.length;e++)delete d[d._linked[e]];delete d._linked}for(f in d)d.hasOwnProperty(f)&&"_"!=f.substr(0,1)&&isArray(d[f])&&(d[f]=JSON.stringify(d[f]));
localStorage.setItem(a._dbTag_+"_item_"+b,JSON.stringify(d));-1==a._list.indexOf(b)&&(a._list[a._list.length]=b,localStorage.setItem(a._dbTag_+"_list",JSON.stringify(a._list)))},setBinItem:function(b,d,c){a.setItem(b,a.toBinString(d),c)},getItem:function(b){b=String(b);b=localStorage.getItem(a._dbTag_+"_item_"+b);b=JSON.parse(b||"{}");if(!isEmpty(b)&&isArray(a._siblingDB)){var d;b._linked=[];for(var c=0;c<a._siblingDB.length;c++){d=a._siblingDB[c].db.getItem(b[a._siblingDB[c].linkage]);for(var e in d)b._linked=
[],d.hasOwnProperty(e)&&"undefined"==typeof b[e]&&(b[e]=d[e],b._linked.push(e))}}return b},getBinItem:function(b){return a.toBinArray(a.getItem(b))},getList:function(){return a._list||[]},linkTo:function(b,d){b&&b.getItem?"undefined"==typeof d&&(b=null):b=d=null;if(b){var c={db:b,linkage:d||null};a._siblingDB=a._siblingDB||[];a._siblingDB.push(c)}},filter:function(b,d,c,e){if("function"==typeof b){c=c||!0;var f=!1,k;!0===c?f=!0:(k=yLexObj(c),k.parse());var l=a.getList(),m,n;for(c=0;c<l.length;c++)if(m=
a.getItem(l[c]),n=f||k.solve(m))b(m),e&&(c=l.length+1)}"function"==typeof d&&d()},each:function(b,d,c,e){var f=function(a,b){b=String(b).split(" ");var d=!0,c,e;for(c in b)e=trim(b[c]),d=isNumber(e)&&isNumber(a)?d&&parseFloat(e)===parseFloat(a):d&&0<=(""+a).toUpperCase().indexOf(e.toUpperCase());return d},k,l=a.getList(),m,n;for(k=0;k<l.length;k++)if("function"==typeof b){m=a.getItem(l[k]);n="undefined"==typeof c;if(!n)if("string"==typeof c)n=f(m[a.cfg.keyName],c);else if("object"==typeof c){n=!0;
for(var g in c)c.hasOwnProperty(g)&&(n="undefined"!==typeof m[g]?n&&f(m[g],c[g]):!1)}n&&(b(m),e&&(k=l.length+1))}"function"==typeof d&&d()},insertData:function(b,d){for(var c in b)b.hasOwnProperty(c)&&a.setItem(b[c][a._keyName_],b[c],d)},count:function(b){var d=0;a.each(function(){d++},null,b);return d},extractData:function(b,d){var c=[];a.each(function(a){c[c.length]=a},function(){b(c)},d)},fillList:function(b,d,c,e){d=d||"id";c&&a.cleanList();for(c=0;c<b.length;c++)b[c][d]&&a.setItem(b[c][d],b,
e)},removeItem:function(b,d){if(("undefined"!==typeof d?d:1)&&"function"==typeof a.onremove)a.onremove(a.getItem(b));localStorage.removeItem(a._dbTag_+"_item_"+b);var c=a._list.indexOf(String(b));-1<c&&(a._list.splice(c,1),localStorage.setItem(a._dbTag_+"_list",JSON.stringify(a._list)))},removeItems:function(b,d){d="undefined"!==typeof d?d:!0;a.extractData(function(b){for(var e in b)b.hasOwnProperty(e)&&a.removeItem(b[e][a._keyName_],d)},b)},eliminateItem:function(b){a.removeItem(b,!1)},eliminateItems:function(b){a.removeItems(b,
!1)},cleanList:function(b){b="undefined"!==typeof b?b:!0;var d=[],c=0,e;for(e in a._list)d[c++]=a._list[e];for(c=0;c<d.length;c++)a.removeItem(d[c],b)},blankList:function(){a.cleanList(!1)},init:function(b,d){a._dbTag_=b;a._keyName_=d||"_id";console.log("ystorage: creating "+b);a._list=localStorage.getItem(a._dbTag_+"_list");"string"==typeof a._list&&(a._list=JSON&&JSON.parse(a._list)||[]);a._list=a._list||[];return a}};return a.init(g,h)},console.log("ystorage ready!"));window.yIndexedDB||(window.indexedDB||
(window.indexedDB=window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB),window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,window.yIndexedDB=function(g,h,a){var b={_newTransaction:function(a,c,e){e=e||function(a){0!==a&&k&&(k=!1,"function"==typeof c&&c(520,a,[{}]))};a=b._db.transaction([b._dbTag_],"readwrite");var f,k=!0;a.oncomplete=function(){f=0;"function"==
typeof e&&e(f)};a.onerror=function(){f=1;"function"==typeof e&&e(f)};return a.objectStore(b._dbTag_)},count:function(a){var c=b._newTransaction("readonly").count();c.onsuccess=function(){"function"==typeof a&&a(200,0,[c.result])}},setItem:function(a,c,e){a=!1;if(3==b.status){c._id=c._id||generateUUID();c._ts_update=(new Date).getTime()/1E3;var f=b._newTransaction("readwrite",e).put(c);f.onsuccess=function(){"function"==typeof e&&e(200,0,[f.result])};a=!0}return a},getItem:function(a,c){var e=!1;if(3==
b.status){var f=b._newTransaction("readonly",c).get(a);f.onsuccess=function(){"function"==typeof c&&c(200,0,[f.result])};e=!0}return e},insertData:function(a,c,e){c=!1;if(3==b.status){c=b._newTransaction("readwrite",e);for(var f=0,k=0,l=0;a&&l<a.length;l++){var g=a[l];g._id=g._id||generateUUID();g._ts_update=(new Date).getTime()/1E3;g=c.put(g);g.onsuccess=function(b){b=b.target;f++;f+k>=a.length&&"function"==typeof e&&e(200,{errorCount:k},[b.result])};g.onerror=function(b){k++;f+k>=a.length&&"function"==
typeof e&&e(200,{errorCount:k},[{}])}}c=!0}return c},filter:function(a,c,e,f){if(3==b.status){var g=function(a){0===a&&"function"==typeof c&&c()};if("function"==typeof a){e=e||!0;var l=!1;if(!0===e)l=!0;else{var h=yLexObj(e);h.parse()}e=b._newTransaction("readonly",void 0,g).openCursor();e.onsuccess=function(b){var c=b.target.result;c&&((b=l||h.solve(c.value))&&a(c.value),f||c.continue())};e.onerror=function(){}}else g(0)}},slice:function(a,c,e,f,g){if(3==b.status){var l=function(a){0===a&&"function"==
typeof c&&c()};if("function"==typeof a){var l=b._newTransaction("readonly",void 0,l).openCursor(),h=0;e=Math.max(0,e);l.onsuccess=function(b){if(b=b.target.result)h<e?(h=e,console.log("Advancing to {0}".format(e)),0<e&&b.advance(e)):(h++,h<=f&&("function"===typeof a&&a(b.value),g||h<f&&b.continue()))};l.onerror=function(){}}else l(0)}},removeItem:function(a,c){var e=!1;if(3==b.status){var f=b._newTransaction("readonly",c).delete(a);f.onsuccess=function(){"function"==typeof c&&c(200,0,f.result)};e=
!0}return e},onDBRequestError:function(a){b._status=-1;console.error("yIndexedDB error trying to open '{0}'".format(g))},onDBRequestSuccess:function(d){b._status=3;b._db=d.target.result;"function"==typeof a&&a()},onDBUpgradeNeeded:function(a){b._status=2;b._db=a.target.result;b._objectStore=b._db.createObjectStore(b._dbTag_,{keyPath:b._keyName_[0]});for(a=1;a<b._keyName_.length;a++)b._objectStore.createIndex(b._keyName_[a]+"_ndx",b._keyName_[a],{unique:!1});b._status=3},init:function(a,c){b._dbTag_=
a;c=c||"_id";if(!isArray(c)){var e=0<=c.indexOf(",")?",":";";c=c.split(e)}b._keyName_=c.slice();0===b._keyName_.length&&(b._keyName_[0]="_id");b._status=0;Object.defineProperty(b,"status",{get:function(){return b._status},configurable:!1,enumerable:!1});window.indexedDB&&(b._status=1,b._DBOpenRequest=window.indexedDB.open(a,1),b._DBOpenRequest.onerror=b.onDBRequestError,b._DBOpenRequest.onsuccess=b.onDBRequestSuccess,b._DBOpenRequest.onupgradeneeded=b.onDBUpgradeNeeded);return b}};return b.init(g,
h)});window.yServerWatcherObj||(window.yServerWatcherObj=function(g){var h={serverReady:function(a,b){var d=(new Date).getTime();ycomm.crave("sync","ping",null,function(c,e,f){200==c?0<parseInt(f.pong||0)&&(c=(new Date).getTime()-d,console.log("Server ready..."),console.log("Wasted time: {0}ms".format(c)),ycomm.wd_interval=4*c,"function"==typeof a&&a()):"function"==typeof b&&b(c,e)})},init:function(){ycomm.setDataLocation(g);h.serverReady(function(){console.log("Server ready!")});return h}};return h.init()});
window.yInfoObj||(window.yInfoObj=function(g,h){var a={};if("object"==typeof g&&"string"==typeof g.dbName)return a.cfg={db:ySingleDb(g.dbName,g.keyName),garbage:ySingleDb(g.dbName+"_garbage",g.keyName),dbName:g.dbName,keyName:g.keyName,dataModified:0,onrecordcount:null,onprogress:null,oncomplete:null},a.onremove=function(b){b._ts_deletion=(new Date).getTime()/1E3;a.cfg.garbage.setItem(b._id,b);a.cfg.dataModified++},a.isbusy=function(){return a.busy},a.getItem=function(b){return a.cfg.db.getItem(b)},
a.setItem=function(b,d,c){a.cfg.dataModified++;return a.cfg.db.setItem(b,d,c)},a.removeItem=function(b){return a.cfg.db.removeItem(b)},a.removeItems=function(b){return a.cfg.db.removeItems(b)},a.eliminateItem=function(b){return a.cfg.db.eliminateItem(b)},a.eliminateItems=function(b){return a.cfg.db.eliminateItems(b)},a.cleanList=function(){return a.cfg.db.cleanList()},a.blankList=function(){return a.cfg.db.blankList()},a.linkTo=function(b,d){return a.cfg.db.linkTo(b,d)},a.filter=function(b,d,c,e){return a.cfg.db.filter(b,
d,c,e)},a.each=function(b,d,c,e){return a.cfg.db.each(b,d,c,e)},a.paint=a.each,a.count=function(b){return a.cfg.db.count(b)},a.extractData=function(b,d){var c=[];a.each(function(a){c[c.length]=a},function(){b(c)},d)},a.insertData=function(b,d){return a.cfg.db.insertData(b,d)},a.cleanCondition=function(){a.cfg.condition={}},a.setCondition=function(b){if("string"==typeof b){b=b.match(/\S+/g);var d,c="";for(d=0;d<b.length;d++)isNumber(b[d])||isOperator(b[d])||(b[d]="%("+b[d]+")"),c+=b[d]+" ";a.cfg.condition=
{_statement_:c}}else a.cfg.condition=b||{}},a.retrieveFromServer=function(b,d,c){var e=function(){var b={xq_start:a.cfg.xq_start,xq_collectionName:a.cfg.dbName},c=(new Date).getTime();mergeObject(a.cfg.condition,b);ycomm.crave("sync","getDocumentInSequence",b,function(b,d,f){if(0<f.length){a.cfg.interleave.adjustRestTime(c);for(b=0;b<f.length;b++)if(a.setItem(f[b][a.cfg.keyName],f[b]),"function"==typeof a.cfg.onprogress)a.cfg.onprogress(a.cfg.dbName,f[b],a.cfg.xq_start+b);a.cfg.xq_start+=f.length;
setTimeout(e,a.cfg.interleave.restTime)}else{if("function"==typeof a.cfg.oncomplete)a.cfg.oncomplete(a.cfg.dbName);a.busy=!1}})};if(a.busy)return console.warn("yInfoObj busy"),!1;a.busy=!0;a.cfg.onrecordcount=b||null;a.cfg.oncomplete=d||null;a.cfg.onprogress=c||null;a.server.serverReady(function(){ycomm.crave("sync","getRecordCount",a.cfg.condition,function(b,c,d){d=d||[];d[0]=d[0]||{};if("function"==typeof a.cfg.onrecordcount)a.cfg.onrecordcount(a.cfg.dbName,parseInt(d[0].CC||0));a.cfg.xq_start=
0;e()})},function(a,b){console.log("Erro {0} ao tentar acessar o servidor: {1}".format(a,b.message))});return!0},a.templatedData=function(b){var d;if(a.cfg.dataTemplateEmpty)d=b;else{d={};for(var c in a.cfg.dataTemplate)a.cfg.dataTemplate.hasOwnProperty(c)&&(d[c]=b[c])}return d},a.sendToServer=function(b,d,c){c=c||console.warn;if(a.busy)return c("yInfoObj busy"),!1;a.busy=!0;a.cfg.onrecordcount=null;a.cfg.oncomplete=b||null;a.cfg.onprogress=d||null;var e=0;a.server.serverReady(function(){a.each(function(b){var d=
a.templatedData(b);b._ts_upload=(new Date(b)).getTime()/1E3;mergeObject(a.cfg.condition,d);ycomm.crave("sync","setDocument",d,function(b,d,f){if(200==b){if("function"==typeof a.cfg.onprogress)a.cfg.onprogress(a.cfg.dbName,f[0],++e)}else c(b+": "+d)})},function(){if("function"==typeof a.cfg.oncomplete)a.cfg.oncomplete(a.cfg.dbName);a.busy=!1},a.cfg.condition)},function(a,b){c("Erro {0} ao tentar acessar o servidor: {1}".format(a,b.message))});return!0},a.init=function(b){a.cfg.interleave=yRestTimeControl(500);
a.cfg.dataTemplateEmpty="undefined"===typeof b?!0:!1;a.cfg.dataTemplate=b||{};a.cfg.db.onremove=a.onremove;a.server=yServerWatcherObj(restServer);a.cleanCondition();return a},a.init(g.dataTemplate);console.error("Since 0.8.55 the parameters or yInfoObj() has changed to (aDBSpec: {}, aServerSpec: {})");alert("Since 0.8.55 the parameters or yInfoObj() has changed to (aDBSpec: {}, aServerSpec: {})")})})();
