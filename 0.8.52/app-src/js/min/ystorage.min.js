(function(){window.ystorage||Object.defineProperty(window,"ystorage",new function(){var g=[],e={};Object.defineProperty(e,"getItem",{value:function(c){return c?this[c]:null},writable:!1,configurable:!1,enumerable:!1});Object.defineProperty(e,"key",{value:function(c){return g[c]},writable:!1,configurable:!1,enumerable:!1});Object.defineProperty(e,"setItem",{value:function(c,b){c&&(document.cookie=escape(c)+"="+escape(b)+"; expires=Tue, 19 Jan 2038 03:14:07 GMT; path=/")},writable:!1,configurable:!1,
enumerable:!1});Object.defineProperty(e,"length",{get:function(){return g.length},configurable:!1,enumerable:!1});Object.defineProperty(e,"removeItem",{value:function(c){c&&(document.cookie=escape(c)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/")},writable:!1,configurable:!1,enumerable:!1});this.get=function(){var c,b;for(b in e)c=g.indexOf(b),-1===c?e.setItem(b,e[b]):g.splice(c,1),delete e[b];for(;0<g.length;g.splice(0,1))e.removeItem(g[0]);for(var a=0,d=document.cookie.split(/\s*;\s*/);a<d.length;a++)c=
d[a].split(/\s*=\s*/),1<c.length&&(e[b=unescape(c[0])]=unescape(c[1]),g.push(b));return e};this.configurable=!1;this.enumerable=!0});window.ySingleDb||(console.log("Creating ySingleDb ... "),window.ySingleDb=function(g,e){var c={_list:null,toBinArray:function(b){for(var a=(b||"").length,d=new Uint8Array(a),c=0;c<a;c++)d[c]=b.charCodeAt(c);return d},toBinString:function(b){b=new Uint8Array(b);for(var a=[],d=0;65535*d<b.length;d++)a.push(String.fromCharCode.apply(null,b.subarray(65535*d,65535*(d+1))));
return a.join("")},setItem:function(b,a){b=String(b);a._id=a._id||generateUUID();a._ts_update=(new Date).getTime()/1E3;if(a._linked){for(var d=0;d<a._linked.length;d++)delete a[a._linked[d]];delete a._linked}for(var f in a)a.hasOwnProperty(f)&&"_"!=f.substr(0,1)&&isArray(a[f])&&(a[f]=JSON.stringify(a[f]));localStorage.setItem(c._dbTag_+"_item_"+b,JSON.stringify(a));-1==c._list.indexOf(b)&&(c._list[c._list.length]=b,localStorage.setItem(c._dbTag_+"_list",JSON.stringify(c._list)))},setBinItem:function(b,
a){c.setItem(b,c.toBinString(a))},getItem:function(b){b=String(b);b=localStorage.getItem(c._dbTag_+"_item_"+b);b=JSON.parse(b||"{}");if(isArray(c._siblingDB)){var a;b._linked=[];for(var d=0;d<c._siblingDB.length;d++){a=c._siblingDB[d].db.getItem(b[c._siblingDB[d].linkage]);for(var f in a)b._linked=[],a.hasOwnProperty(f)&&"undefined"==typeof b[f]&&(b[f]=a[f],b._linked.push(f))}}return b},getBinItem:function(b){return c.toBinArray(c.getItem(b))},getList:function(){return c._list||[]},linkTo:function(b,
a){b&&b.getItem?"undefined"==typeof a&&(b=null):b=a=null;if(b){var d={db:b,linkage:a||null};c._siblingDB=c._siblingDB||[];c._siblingDB.push(d)}},filter:function(b,a,d){if("function"==typeof b){d=yLexObj(d||!0);d.parse();var f,h=c.getList(),e,k;for(f=0;f<h.length;f++)e=c.getItem(h[f]),(k=d.solve(e))&&b(e)}"function"==typeof a&&a()},each:function(b,a,d){var f=function(a,d){d=String(d).split(" ");var b=!0,c,f;for(c in d)f=trim(d[c]),b=isNumber(f)&&isNumber(a)?b&&parseFloat(f)===parseFloat(a):b&&0<=(""+
a).toUpperCase().indexOf(f.toUpperCase());return b},h,e=c.getList(),k,l;for(h=0;h<e.length;h++)if("function"==typeof b){k=c.getItem(e[h]);l="undefined"==typeof d;if(!l)if("string"==typeof d)l=f(k[c.cfg.keyName],d);else if("object"==typeof d){l=!0;for(var g in d)d.hasOwnProperty(g)&&(l="undefined"!==typeof k[g]?l&&f(k[g],d[g]):!1)}l&&b(k)}"function"==typeof a&&a()},insertData:function(b){for(var a=0;a<b.length;a++)c.setItem(b[a][c._keyName_],b[a])},count:function(b){var a=0;c.each(function(){a++},
null,b);return a},extractData:function(b,a){var d=[];c.each(function(a){d[d.length]=a},function(){b(d)},a)},fillList:function(b,a,d){a=a||"id";d&&c.cleanList();for(d=0;d<b.length;d++)b[d][a]&&c.setItem(b[d][a],b)},removeItem:function(b){if("function"==typeof c.onremove)c.onremove(c.getItem(b));localStorage.removeItem(c._dbTag_+"_item_"+b);b=c._list.indexOf(String(b));-1<b&&(c._list.splice(b,1),localStorage.setItem(c._dbTag_+"_list",JSON.stringify(c._list)))},cleanList:function(){var b=[],a=0,d;for(d in c._list)b[a++]=
c._list[d];for(a=0;a<b.length;a++)c.removeItem(b[a])},init:function(b,a){c._dbTag_=b;c._keyName_=a||"_id";console.log("ystorage: creating "+b);c._list=localStorage.getItem(c._dbTag_+"_list");"string"==typeof c._list&&(c._list=JSON&&JSON.parse(c._list)||[]);c._list=c._list||[];return c}};return c.init(g,e)},console.log("ystorage ready!"));window.yServerWatcherObj||(window.yServerWatcherObj=function(g){var e={serverReady:function(c,b){var a=(new Date).getTime();ycomm.crave("sync","ping",null,function(d,
f,h){200==d?0<parseInt(h.pong||0)&&(d=(new Date).getTime()-a,console.log("Server ready..."),console.log("Wasted time: {0}ms".format(d)),ycomm.wd_interval=4*d,"function"==typeof c&&c()):"function"==typeof b&&b(d,f)})},init:function(){ycomm.setDataLocation(g);e.serverReady(function(){console.log("Server ready!")});return e}};return e.init()});window.yInfoObj||(window.yInfoObj=function(g,e,c,b){var a={};a.cfg={db:ySingleDb(e,c),garbage:ySingleDb(e+"_garbage",c),dbName:e,keyName:c,dataModified:0,onrecordcount:null,
onprogress:null,oncomplete:null};a.onremove=function(d){d._ts_deletion=(new Date).getTime()/1E3;a.cfg.garbage.setItem(d._id,d);a.cfg.dataModified++};a.isbusy=function(){return a.busy};a.getItem=function(d){return a.cfg.db.getItem(d)};a.setItem=function(d,b){a.cfg.dataModified++;return a.cfg.db.setItem(d,b)};a.removeItem=function(d){return a.cfg.db.removeItem(d)};a.linkTo=function(d,b){return a.cfg.db.linkTo(d,b)};a.filter=function(d,b,c){return a.cfg.db.filter(d,b,c)};a.each=function(d,b,c){return a.cfg.db.each(d,
b,c)};a.paint=a.each;a.count=function(d){return a.cfg.db.count(d)};a.extractData=function(d,b){var c=[];a.each(function(a){c[c.length]=a},function(){d(c)},b)};a.insertData=function(d){return a.cfg.db.insertData(d)};a.cleanCondition=function(){a.cfg.condition={}};a.setCondition=function(d){if("string"==typeof d){d=d.match(/\S+/g);var b,c="";for(b=0;b<d.length;b++)isNumber(d[b])||isOperator(d[b])||(d[b]="%("+d[b]+")"),c+=d[b]+" ";a.cfg.condition={_statement_:c}}else a.cfg.condition=d||{}};a._retrieveFromServer=
function(){var b={xq_start:a.cfg.xq_start,xq_collectionName:a.cfg.dbName},c=(new Date).getTime();mergeObject(a.cfg.condition,b);ycomm.crave("sync","getDocumentInSequence",b,function(b,d,e){if(0<e.length){a.cfg.interleave.adjustRestTime(c);for(b=0;b<e.length;b++)if(a.setItem(e[b][a.cfg.keyName],e[b]),"function"==typeof a.cfg.onprogress)a.cfg.onprogress(a.cfg.dbName,e[b],a.cfg.xq_start+b);a.cfg.xq_start+=e.length;setTimeout(a._retrieveFromServer,a.cfg.interleave.restTime)}else{if("function"==typeof a.cfg.oncomplete)a.cfg.oncomplete(a.cfg.dbName);
a.busy=!1}})};a.retrieveFromServer=function(b,c,e){if(a.busy)return console.warn("yInfoObj busy"),!1;a.busy=!0;a.cfg.onrecordcount=b||null;a.cfg.oncomplete=c||null;a.cfg.onprogress=e||null;a.server.serverReady(function(){ycomm.crave("sync","getRecordCount",a.cfg.condition,function(b,c,d){d=d||[];d[0]=d[0]||{};if("function"==typeof a.cfg.onrecordcount)a.cfg.onrecordcount(a.cfg.dbName,parseInt(d[0].CC||0));a.cfg.xq_start=0;a._retrieveFromServer()})},function(a,b){console.log("Erro {0} ao tentar acessar o servidor: {1}".format(a,
b.message))});return!0};a.templatedData=function(b){var c;if(a.cfg.dataTemplateEmpty)c=b;else{c={};for(var e in a.cfg.dataTemplate)a.cfg.dataTemplate.hasOwnProperty(e)&&(c[e]=b[e])}return c};a.sendToServer=function(b,c){if(a.busy)return console.warn("yInfoObj busy"),!1;a.busy=!0;a.cfg.onrecordcount=null;a.cfg.oncomplete=b||null;a.cfg.onprogress=c||null;var e=0;a.server.serverReady(function(){a.each(function(b){var c=a.templatedData(b);b._ts_upload=(new Date(b)).getTime()/1E3;mergeObject(a.cfg.condition,
c);ycomm.crave("sync","setDocument",c,function(b,c,d){if(200==b&&"function"==typeof a.cfg.onprogress)a.cfg.onprogress(a.cfg.dbName,d[0],++e)})},function(){if("function"==typeof a.cfg.oncomplete)a.cfg.oncomplete(a.cfg.dbName);a.busy=!1},a.cfg.condition)},function(a,b){console.log("Erro {0} ao tentar acessar o servidor: {1}".format(a,b.message))});return!0};a.init=function(b){a.cfg.interleave=yRestTimeControl(500);a.cfg.dataTemplateEmpty="undefined"===typeof b?!0:!1;a.cfg.dataTemplate=b||{};a.cfg.db.onremove=
a.onremove;a.server=yServerWatcherObj(g);a.cleanCondition();return a};return a.init(b)})})();
